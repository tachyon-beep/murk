# v0.1.9 Release Readiness Review

**Date:** 2026-02-24
**Branch:** `feat/release-0.1.9` (35 commits, 128 files, +10,979/-1,347 lines)
**Reviewers:** 4-agent parallel review (code quality, silent failures, test coverage, code simplification)

## Verdict: READY — all 3 blockers, 8 important issues, and 8 suggestions addressed

---

## 1. Blockers (must fix before release)

### B-1. `WavePropagation::max_dt` ignores `space` parameter — silent instability

**File:** `crates/murk-propagators/src/wave_propagation.rs:304`
**Found by:** Silent failure hunter

The `max_dt(&self, space: &dyn Space)` signature change in this release was specifically
to allow propagators to query actual space topology for CFL stability bounds.
`DiffusionPropagator` and `ScalarDiffusion` were both correctly updated to call
`space.max_neighbour_degree()`. `WavePropagation` was given the new signature but
ignores the parameter entirely, hardcoding `12.0`:

```rust
fn max_dt(&self, _space: &dyn murk_space::Space) -> Option<f64> {
    // CFL: dt <= 1 / (wave_speed * sqrt(max_degree))
    // Worst case: FCC-12 with degree 12.
    Some(1.0 / (self.wave_speed * 12.0_f64.sqrt()))
}
```

**Impact:** On spaces with degree > 12, the CFL bound is too permissive — the simulation
silently diverges with no error. On Square4 (degree 4), it is sqrt(3)x too conservative.

**Fix:** Use `space.max_neighbour_degree()` like the other propagators:

```rust
fn max_dt(&self, space: &dyn murk_space::Space) -> Option<f64> {
    let max_degree = space.max_neighbour_degree();
    if max_degree == 0 {
        return None;
    }
    Some(1.0 / (self.wave_speed * (max_degree as f64).sqrt()))
}
```

**Status:** [x] Fixed

---

### B-2. `MurkWorldPreflight` missing compile-time size assertion — ABI fragility

**File:** `crates/murk-ffi/src/world.rs:26-39`
**Found by:** Code reviewer, test coverage analyzer

Every other `#[repr(C)]` FFI struct (`MurkStepMetrics` at `metrics.rs:74-75`) has
compile-time size and alignment assertions. `MurkWorldPreflight` does not. The struct
has implicit padding between `tick_disabled: u8` and `consecutive_rollbacks: u32`.
A future field insertion or reorder will silently change the ABI without any compiler
error, causing memory corruption across the FFI boundary.

**Fix:** Add after the struct definition:

```rust
const _: () = assert!(std::mem::size_of::<MurkWorldPreflight>() == 24);
const _: () = assert!(std::mem::align_of::<MurkWorldPreflight>() == 8);
```

**Status:** [x] Fixed

---

### B-3. `murk_last_panic_message` returns `len as i32` — truncation risk

**File:** `crates/murk-ffi/src/lib.rs:115`
**Found by:** Code reviewer

```rust
let len = msg.len();   // usize
len as i32             // returned to caller
```

If `len > i32::MAX`, the `as i32` cast wraps to negative (or 0, which means "no panic
recorded"). The function returns `0i32` to mean "no panic" (line 111), so a wrapped
cast could cause the caller to incorrectly conclude no panic occurred.

**Fix:**

```rust
len.min(i32::MAX as usize) as i32
```

**Status:** [x] Fixed

---

## 2. Important Issues (should fix before release)

### I-1. `ffi_guard_or!(0)` returns 0 for valid state AND errors — 7 functions

**Files:** `world.rs:262,297,332,395` and `batched.rs:329,354,379`
**Found by:** Silent failure hunter

`murk_current_tick`, `murk_seed`, `murk_is_tick_disabled`, `murk_consecutive_rollbacks`,
`murk_batched_num_worlds`, `murk_batched_obs_output_len`, `murk_batched_obs_mask_len`
all return 0 for invalid handle, poisoned mutex, and caught panic —
indistinguishable from valid tick 0 or seed 0. The `_get` variants exist and return
proper `MurkStatus`, so this is a documentation issue rather than a missing-API issue.

**Fix:** Add prominent documentation warning that these convenience functions cannot
report errors. Consider deprecating in favor of `_get` variants long-term.

**Status:** [x] Fixed — added ambiguity warnings to 3 batched functions (world.rs already had them)

---

### I-2. `BatchError::_` wildcard maps unknown variants to `ConfigError`

**File:** `crates/murk-ffi/src/batched.rs:325`
**Found by:** Silent failure hunter

```rust
Err(e) => {
    return match &e {
        murk_engine::batched::BatchError::Config(ce) => MurkStatus::from(ce) as i32,
        murk_engine::batched::BatchError::Observe(oe) => MurkStatus::from(oe) as i32,
        _ => MurkStatus::ConfigError as i32,
    };
}
```

Future `BatchError` variants (e.g., `NoObsPlan`, `InvalidArgument`, `BufferTooSmall`)
silently become `ConfigError`, losing the actual error type.

**Fix:** Replace `_ =>` with explicit arms for every `BatchError` variant, or map
unknown variants to `InternalError` with logging.

**Status:** [x] Fixed — replaced wildcard with existing exhaustive `batch_error_to_status()` helper

---

### I-3. Poisoned mutex returns `InternalError` with no diagnostic

**Files:** Throughout `batched.rs` and `world.rs`
**Found by:** Silent failure hunter, code reviewer

Every `Err(_)` branch from `Mutex::lock()` returns `MurkStatus::InternalError` with
zero diagnostic information. No `LAST_PANIC` message, no log. A poisoned mutex means
a prior panic corrupted shared state — users need to know this happened.

**Fix options:**
- Store diagnostic in `LAST_PANIC`: `"mutex poisoned: prior panic corrupted shared state"`
- Return `MurkStatus::Panicked` instead of `InternalError`
- At minimum, log at error level

**Status:** [x] Fixed — `ffi_lock!` macro now stores diagnostic in LAST_PANIC; batched.rs bare locks addressed by S-1

---

### I-4. `IngressError::NotApplied` maps to `InvalidArgument` — wrong error semantics

**File:** `crates/murk-ffi/src/status.rs:113`
**Found by:** Silent failure hunter

```rust
IngressError::NotApplied => MurkStatus::InvalidArgument,
```

`NotApplied` is the new error for SetField commands targeting out-of-bounds coordinates
(BUG-099 fix). `InvalidArgument` is used for malformed FFI calls (null pointers, bad
enum values). A SetField with an OOB coordinate is a valid FFI call with a valid command
structure — it targets a coordinate that does not exist. These are semantically different.

**Fix:** Either add `MurkStatus::CommandNotApplied` or use `MurkStatus::UnsupportedCommand`.

**Status:** [x] Fixed — mapped to `UnsupportedCommand` (avoids ABI-breaking new variant)

---

### I-5. `murk_obsplan_execute` uses `unwrap_or(0)` for buffer size — zero-length bypass

**File:** `crates/murk-ffi/src/obs.rs:263`
**Found by:** Silent failure hunter

```rust
let expected_out = plan_state.cache.output_len().unwrap_or(0);
```

If `output_len()` returns `None` (plan not compiled), `expected_out = 0`, buffer check
passes vacuously, execution proceeds, and the plan panics during execution. Users get
`Panicked` instead of "plan not compiled."

**Fix:**

```rust
let expected_out = match plan_state.cache.output_len() {
    Some(v) => v,
    None => return MurkStatus::InvalidObsSpec as i32,
};
```

**Status:** [x] Fixed — returns `InvalidObsSpec` when plan not compiled (mirrors `execute_agents` pattern)

---

### I-6. `cancel_tick()` has no direct unit test

**File:** `crates/murk-arena/src/pingpong.rs:417`
**Found by:** Test coverage analyzer

The rollback recovery path. If `cancel_tick` fails to reset state, the tick engine
permanently deadlocks after any rollback event. Only tested indirectly through
`begin_tick_reentry_returns_error`.

**Fix:** Add a direct test verifying that after `cancel_tick()`, a subsequent
`begin_tick()` succeeds:

```rust
#[test]
fn cancel_tick_allows_subsequent_begin_tick() {
    let mut arena = make_arena();
    let _guard = arena.begin_tick().unwrap();
    drop(_guard);
    arena.cancel_tick();
    let _guard2 = arena.begin_tick().unwrap();
}
```

**Status:** [x] Fixed

---

### I-7. `execute_batch` generation validation untested

**File:** `crates/murk-obs/src/plan.rs`
**Found by:** Test coverage analyzer

The new `compiled_generation` vs `world_generation_id()` check prevents stale obs plans
from producing wrong observations — a correctness-critical feature. Zero test coverage.

**Fix:** Add a test that compiles a plan, passes snapshots from a different generation,
and verifies `ObsError::PlanInvalidated` is returned.

**Status:** [x] Fixed — `execute_batch_rejects_mismatched_generation` test added

---

### I-8. `pool_2d_into` and `graph_distance` use `assert!` instead of `Result` on FFI paths

**Files:** `crates/murk-obs/src/pool.rs:65-81`, `crates/murk-obs/src/geometry.rs:163`
**Found by:** Silent failure hunter, code reviewer

Both are called during observation execution from FFI. `ffi_guard!` catches the panics,
but users get `MurkStatus::Panicked` with assertion failure text instead of actionable
error codes (`InvalidObsSpec` or `BufferTooSmall`).

**Fix:** Convert `assert!`/`assert_eq!` to return `Result<_, ObsError>` and propagate
through the execution pipeline. The allocating `pool_2d` (test-only) can keep its asserts.

**Status:** [x] Fixed — both now return `Result<_, ObsError>`, propagated through `execute_agent_entry` chain

---

## 3. Suggestions (nice-to-have, not blocking)

### S-1. Extract `get_batched()` helper in `batched.rs`

**File:** `crates/murk-ffi/src/batched.rs`

8-line arc-acquire boilerplate repeated 6 times. `world.rs` and `obs.rs` already have
`get_world()` and `get_obs_plan()` helpers following this pattern. Saves ~40 lines and
brings batched module into convention.

**Status:** [x] Done

### S-2. Flatten `ring_preflight` duplicated fields

**File:** `crates/murk-engine/src/egress.rs:89-127`

7 identical field assignments in both `Some` and `None` arms of `ring.peek_latest()`.
Build base struct first, then set snapshot-specific fields with `if let Some(...)`.

**Status:** [x] Done

### S-3. Extract `CumulativeCounters` struct in `tick.rs`

**File:** `crates/murk-engine/src/tick.rs`

9 `total_*` counter fields initialized to 0 in `new()`, reset to 0 in `reset()`, and
assigned in the metrics builder. A `#[derive(Default)]` struct keeps the three locations
in sync and prevents "forgot to reset one field" bugs.

**Status:** [x] Done

### S-4. Explicit arms in `submit_commands` match

**File:** `crates/murk-engine/src/tick.rs:217`

`_ => {}` silently ignores `IngressError::ShuttingDown`, `IngressError::UnsupportedCommand`,
`IngressError::NotApplied`, and future variants. Add explicit arms so the compiler warns
on new variants.

**Status:** [x] Done

### S-5. Document `execute_batch` partial-write-on-error behavior

**File:** `crates/murk-obs/src/plan.rs:323`

If generation check fails on snapshot N>0, output slots 0..N-1 are already written.
Either pre-validate in a separate loop or document this behavior.

**Status:** [x] Done

### S-6. Add `ks`/`stride` validation to `pool_2d_output_shape`

**File:** `crates/murk-obs/src/pool.rs:37`

`pool_2d` asserts `ks > 0` and `stride > 0`, but the extracted `pool_2d_output_shape`
does not. A zero `stride` would cause divide-by-zero.

**Status:** [x] Done

### S-7. Shared `test_space()` helper for propagator tests

**Files:** Multiple in `crates/murk-propagators/src/`

7 propagator modules each construct a throwaway `Square4` just to call `max_dt`. The
pipeline tests already solved this with `fn test_space()`.

**Status:** [x] Done

### S-8. Additional test gaps (5 items)

- `pool_2d_into` `#[should_panic]` test for undersized buffers
- `Fcc12::max_neighbour_degree` with 1x1x1 Absorb (hardcoded 12 may be wrong)
- `IngressError::NotApplied` Display format test
- `BatchedVecEnv` tick_id increment after auto-reset
- `ScalarDiffusion::max_dt` with `max_degree > 0` and `space.degree == 0`

**Status:** [x] Done

---

## 4. Strengths

The release demonstrates strong engineering discipline in several areas:

- **FFI panic hardening** — `ffi_guard!`/`ffi_guard_or!` on all 41 `extern "C"` functions
  with `MurkStatus::Panicked` and retrievable panic messages via `murk_last_panic_message`
- **Bug regression tests** — Every fixed bug (BUG-100 through BUG-107) has a dedicated
  regression test with clear failure-mode commentary
- **Overflow prevention** — Systematic `checked_mul`, `saturating_mul`, `saturating_add`
  throughout tick engine and thread timing
- **ABI discipline** — Version bump from 2 to 3 when metrics struct layout changed
- **Topology-aware CFL** — `ScalarDiffusion` tests include a custom `SkewDegreeSpace`
  mock verifying full-topology scan for worst-case degree
- **Ring buffer telemetry** — Read-side counters (eviction, stale reads, skew retries)
  provide exactly the observability needed to diagnose production ring buffer issues
  without adding overhead to the write path
- **Cross-batch panic isolation** — `Arc<Mutex<BatchedEngine>>` prevents one batch's
  panic from corrupting others
- **BUG-101 (diffusion gradient)** — The `signed_delta()` function correctly handles
  three-candidate minimal displacement for toroidal grids
- **BUG-102 (agent movement)** — Changing from all-zero detection to `tick_id == TickId(1)`
  eliminates false positive re-initialization
- **Observation pipeline optimization** — `pool_2d_into` allocation elimination,
  pre-filtered `active_ops`, and pre-computed `valid_count` are well-targeted hot-path
  optimizations

---

## 5. Recommended Action Plan

1. **Fix B-1, B-2, B-3** — All are small, targeted fixes (< 10 lines total)
2. **Fix I-5, I-8** — Latent correctness bugs
3. **Add tests for I-6, I-7** — Critical paths with zero coverage
4. **Document I-1, I-3, I-4** — At minimum, document the limitations
5. **Run `cargo test --workspace`** after fixes to verify no regressions
6. **Iterate on suggestions** as time allows
